데이터셋
=================

이 장에서는 분석에 필요한 ALICE 데이터셋 스테이징을 요청하고 데이터셋의 스테이징 현황을 확인 하는 방법과 사용자의 분석 결과 파일을 KIAF 스토리지로 복사하는 방법에 대해 알아보겠습니다

.. _dataset_request:

ALICE 데이터셋 스테이징 요청
-------------------------------------

KIAF에서는 Alien과 같이 그리드에 위치한 데이터셋이 아닌 로컬에 위치한 데이터셋을 이용하여 분석을 수행 합니다. 
따라서 사용자 분석에 필요한 데이터는 담당자에게 요청하여 로컬 디스크로 스테이징 되도록 해야 합니다. 
데이터셋 스테이징 요청은 메일을 통해 이루 어 집니다. 
데이터셋 스테이징 요청 메일은 *Data:Sim*, *Period*, *Run Number*, *Variant*, *Pass* 등 필요한 데이터셋의 정보를 기입하여 ``kiaf-data-request<no_spam>kisti.re.kr`` 로 보내 주시면 됩니다. **위 메일은 데이터셋 스테이징을 요청할 때에만 이용하고, 일반적인 문의 는 ``kiaf-support<no_spame>kisti.re.kr`` 를 이용하기를 요청 드립니다.**
요청하신 데이터셋은 ``/xrootfs/alice`` 디렉토리 아래에 ``Alien Catalogue`` 와 같은 경로로 저장 되어 있습니다.

> /xrootdfs/alice/alice/sim/2014/LHC14g3c/195831/001/AliAOD.root

ALICE 데이터셋 조회
--------------------------------------


데이터셋을 조회하는 목적에 따라 확인하는 방법이 2가지로 나뉩니다. 
하나는 스테이징 을 요청하기에 앞서 혹은 스테이징을 요청한 이후에 KIAF에 스테이징되어있는 데이터셋의 현황을 조회하는 것입니다. 
다른 하나는 스테이징이 완료된 데이터를 분석하기 위해 실제 파일의 위치를 조회하는 것입니다.

데이터셋 스테이징 현황 조회
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

사용자가 직접 요청한 데이터셋 및 KIAF에 스테이징되어 있는 전체 데이터셋을 조회할 수 있는 명령어가 준비 되어 있습니다. 
명령어 ``showdataset`` 을 이용하여 테이터 스테이징 현황 및 정보를 조회 할 수 있습니다. 
특정 데이터셋의 현황을 조회하기 위해서는 명령어와 함께 조회를 원하는 데이터셋의 이름을 적어주면 해당하는 데이터셋만 조회됩니다. 

.. note::

  데이터셋의 이름을 ``grep`` 하는 것과 같은 결과 값을 보이며 정규표현식 이용이 가능 합니다.

조회할 데이터셋의 이름을 적어주지 않으면 KIAF에 스테이징 되어 있는 전체를 데이터셋을 출력하 게며, 조회되는 양이 많아 출력에 오랜 시간이 소요 될 수 있습니다.

.. code-block:: console

  [계정명@<kiaf_url>  ̃]$ showdatalist LHC14g3c
  Dataset                   Queued  Down  Success  Fail  TotalSize  StagedSize
  sim/2014/LHC14g3c/195831  0       0     11896    0     126.6GB    126.6GB     100%
  sim/2014/LHC14g3c/195871  0       0     11929    0     127.6GB    127.6GB     100%
  sim/2014/LHC14g3c/195872  0       0     4949     0     53.1GB     53.1GB      100%

데이터셋 파일 조회
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

위 :ref:`dataset_request` 절에서 언급한 것과 같이 KIAF에 저장되어 있는 데이터는 */xrootdfs/alice* 디렉토리 아래에 위치합니다. 
일반적인 디렉토리와 같이 직접 디렉토리에 접근하는 것이 가능하며, ``ls`` 등의 명령어를 통해 직접 파일 목록을 확인 할 수 있습니다. 
사용자의 편의를 위하여 요 청한 데이터셋의 전체 파일을 목록화하여 제공합니다. 
데이터 리스트 파일은 */pool/datalist* 디렉토리 아래에 위치하며, 각 데이터셋의 정보를 기반으로 *type_period_run_pass_variant.txt* 의 파일명으로 존재합니다.

> sim_LHC14g3c_195831_AOD.txt

사용자 분석 결과 파일 복사
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

데이터 스토리지에 비해 사용자 홈 디렉토리의 용량이 한정적임으로 분석파일의 사이즈가 큰 경우 홈 디렉토리에 계속해서 보관하는데에 어려움이 있습니다. 
이 문제를 해결하고자 사용자 분석 결과 파일을 데이터 스토리지로 복사하는 기능을 제공하고 있습니다. 
명령어는 ``kiafcp`` 로 정의 되어 있습니다. 
``-h`` 또는 ``--help`` 옵션 사용시 도움말을 제공하고, 파일 복사를 위해 ``--cp`` 옵션 사용시 첫번째 변수를 대상 파일, 두번째 변수를 파일 저장위치와 파일명으로 지정해야 합니다. 

.. note::

  파일명을 입력하지 않으면 마지막 디렉토리 이름으로 파일이 저장 되니 주의해야 합니다.
  
``kiafcp`` 명령어는 옵션과 변수가 없이는 동작하지 않으니 사용에 주의하 여 주시기 바랍니다. 
파일의 저장위치는 */xrootdfs/alice/home/계정명* 이 기본 위치입니다.

.. code-block:: console

  [계정명@<kiaf_url>  ̃]$ kiafcp
  Please use with option and argument
  options:
   -h, --help       : Display help
   --cp             : File copy
   
  Example:
  kiafcp --cp <src> <dest>

  [계정명@<kiaf_url>  ̃]$ kiafcp --cp testfile testfile
  17-01-13 13:12:22
  User 계정명 start to copy testfile to /xrootdfs/alice/home/kiaf_tester/testfile
  (OB/OB] [100%] [==========================================] (0B/s]
  [계정명@<kiaf_url>  ̃]$ ls -1 /xrootdfs/alice/home/계정명/ 합계 1
  -rw-rw-rw-. 1 xrootd xrootd 0 2017-01-13 13:12 testfile
